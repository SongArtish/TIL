# 합의 알고리즘

---

[TOC]

---



## Overview

합의 알고리즘(Consensus Algorithm)은 다수의 참여자들이 통일된 의사결정을 하기 위해 사용하는 알고리즘을 말한다.

> 동의어: 합의 모델, 합의 방식, 합의 메커니즘, 합의 프로토콜

블록체인의 데이터는 흩어져 있는 수많은 노드에 보관되기 때문에, 각각의 노드들은 블록의 데이터가 원본이라는 것을 상호간에 합의하는 과정이 필요하다. 네트워크를 올바른 방향으로 이끌고자하는 다수의 노드들이 상호 검증을 거쳐 올바른 블록 생성을 이끌어내는 프로세스와 알고리즘을 바로 합의(Consensus)라고 한다.



## 속성

합의 프로토콜은 다음의 두 속성을 만족시켜야 한다.

- **Safety**: 문제 없는 노드 사이에서는 잘못된 합의가 이루어지지 않는다.
- **Liveness**: 문제 없는 노드들은 반드시 합의한다.

### FLP Impossibility

FLP Impossibility(FLP Theorem)는 Byzantine Failure가 아닌 Fail-Stop Failure가 하나만 있어도 safety와 liveness를 둘 다 만족하는 합의 알고리즘이 존재할 수 없다는 것을 증명한다. 따라서, 합의 알고리즘을 선택한다는 것은 사실상 safety와 liveness 중 무엇을 선택/포기할지의 문제이다.

### Liveness over Safety

> 잘못된 합의가 이루어질 수 있지만 어떻게든 합의는 한다.
>
> - 예시) 블록체인 PoW: 51% 발생 가능성, safety는 보장하지 않음

대표적으로 비트코인의 합의 알고리즘은 liveness를 중시한다.

- Nakamoto Consensus: 비트코인의 합의 알고리즘은 현재 체인보다 더 긴 체인을 만들 해시 파워만 있으면, 언제든지 현재 합의된 블록을 다른 블록으로 대체할 수 있는데, 블록체인에서는 이런 방식을 Finality(완결성)이 보장되지 않았다고 한다. FLP Impossibility에서는 liveness를 위해 safety를 포기했다고 말한다.
- Casper: 이더리움에서는 기존의 PoW로 liveness를 보장하여 블록을 생성하지만, 50블록마다 투표하여 safety가 보장되는 지점을 만든다.

> **완결성(Finality)**: 블록체인 설정에서, 일단 블록체인에 커밋되면 잘 구성된 모든 블록이 취소되지 않는다는 확인이다.

### Safety over Liveness

> 잘못된 가능성이 있다면 블록을 만들지 않는다.
>
> - 예시) Cosmos Tendermint: 메시지가 시간 안에 도착하지 않으면 블록 생성 안 함

이와 반대로 PBFT에 기반 BFT 계열 합의 알고리즘은 safety를 중시한다.

- Tendermint: Cosmos에서 사용하는 BFT 알고리즘으로, 하나의 라운드가 `Propose`, `Prevote`, `Precommit` 3개의 단계로 나누어진다. Prevote와 Precommit 스텝에서 각각 2/3+1개 이상 모아야 합의가 이루어진다. 합의에 2/3+1개 이상의 동의가 필요하기 때문에 어떤 상황에서도 서로 다른 두 블록이 동시에 생성되는 일은 없다. 하지만 전송한 메시지가 시간 안에 도달하는 것을 보장하지 못하는 비동기 네트워크에서는 합의가 이루어지지 않아 블록이 생성되지 않을 수 있다. 따라서 liveness는 보장되지 않는다.

  Tendermint는 정해진 시간 안에 메시지가 도달하는 것이 보장되지만, 그 정해진 시간을 알 수 없다는 Partial Synchronous Network Model을 사용한다. BFT 계열 합의 알고리즘은 블록 생성을 위해 2번의 투표를 모아야 하는데, Partial Synchronous Network Model에서는 언젠가 합의될 것이 보장되지만, 최악의 경우 몇 번의 라운드 동안 새 블록이 생성되지 않는 경우도 생기며 이는 TPS 저하를 초래한다.

BFT 계열에서는 다른 네트워크 모델에서 liveness가 보장됨을 증명한다.



## 주요 고려사항

합의 알고리즘에서는 다음의 세 가지를 공통적으로 고려해야 한다.

- Finality Problem(완결성 문제)
- 51% Attack/BTF(51% 공격과 비잔틴 결함)
- Transaction Cost(트랜잭션 수수료)

# 합의 알고리즘 종류

여기서는 합의 알고리즘의 종류에 무엇이 있는지 알아본다.

|                                  | 작업증명<br />Proof of Work(PoW) |     지분증명<br />Proof of Stake(PoS)      |   Byzantine Fault Tolerance(BFT)    |
| :------------------------------: | :------------------------------: | :----------------------------------------: | :---------------------------------: |
|      **제안자격 취득방법**       |  목표값 이하의 해시를 찾는 작업  | 플랫폼 토큰을 보유한 양과 기간에 따라 결정 | 정해진 순번 또는 정해진 확률에 의해 |
|      **네트워크 참여 제한**      |               없음               |                없거나 낮음                 |                높음                 |
| **합의에 필요한 연산량 및 비용** |               높음               |                    낮음                    |                낮음                 |
|             **위험**             |             51% 공격             |                  51% 공격                  |                담합                 |
|      **대표적인 블록체인**       |        비트코인, 이더리움        |                casper, EOS                 |            Hyeperledger             |

|           체인 공개 유형           | 합의 방식 | 설명 |                             장점                             |                             단점                             |               사용 코인                |
| :--------------------------------: | :-------: | :--: | :----------------------------------------------------------: | :----------------------------------------------------------: | :------------------------------------: |
|  퍼블릭<br />비허가형<br />공개형  |  **PoW**  |      |                       오랫동안 검증됨                        | 51% Attck<br />완결성 문제<br />느린 트랜잭션<br />에너지 낭비 |                비트코인                |
|                                    |  **PoS**  |      | 51% Attack<br />내성<br />빠른 트랜잭션<br />에너지 낭비 적음 |                  완결성 문제<br />검증 부족                  |       퀀텀 네오<br />스트라디스        |
|                                    | **DPoS**  |      |             빠른 트랜잭션<br />에너지 낭비 적음              | 완전성 문제<br />검증 부족<br />탈중앙성 부족<br />보안 취약 | 스팀<br />이오스<br />아크<br />라이츠 |
|                                    | **PoET**  |      |           검증된 방법의 개선<br />에너지 낭비 적음           |                         특정 HW 종속                         |                 쏘투스                 |
| 프라이빗<br />허가형<br />컨소시엄 | **PBFT**  |      |             완결성 문제 해결<br />빠른 트랜잭션              |     참여자 사전 파악 필요<br />참가자 증가 시 성능 하락      |                 페브릭                 |
|                                    |  **PoA**  |      |                                                              |                                                              |                                        |
|                                    | **PAXOS** |      |                                                              |                                                              |                                        |
|                                    | **RAFT**  |      |                                                              |           리더의 조작 가능<br />BTF 보장하지 않음            |                                        |
|                                    | **Sieve** |      |                                                              |                                                              |                                        |





## 작업증명(PoW)

작업 증명(Proof of Work)은 사토시 나카모토가 제안한 합의 알고리즘으로, 블록생성 시간 동안 가장 많은 **해시파워**를 제공한 노드가 블록을 생성할 수 있도록 설계가 되었다. 블록을 생성하기 위해 논스(nonce)라는 임의의 값을 맞히는 과정을 채굴(mining)이라고 한다. 작업증명에서는 브랜치가 생긴 경우 가장 긴 블록체인이 남을 때까지 서로 경쟁하여 이긴 브랜치가 최종적인 브랜치로 채택이 되며, 다른 브랜치는 버려진다.

작업 증명은 현재 **시빌 공격(Sybil Attack)**과 같은 블록체인 네트워크에 대한 각종 공격을 막을 수 있다고 증명된 유일한 알고리즘이다.

> 시빌공격: 공격자가 실제로는 한 명이면서, 마치 여러 명인 것처럼 속이는 방식으로 네트워크 상의 여러 노드를 제어함으로써, 의사결정에 좋지 않은 영향을 미치는 공격

```markdown
### 장점
- 현재 높은 시장 가치를 형성하고 있는 주류 코인들이 채택하고 있다.
- 강력한 보안성을 제공한다.
- 서비스 남용을 쉽게 방지할 수 있다.
### 단점
- 높은 전력 소모를 통해 자원을 낭비한다.
- 지속적으로 해시파워를 유지해야 한다.
- 특정 마이닝 세력의 해시 독점으로 인한 생태계 교란 우려가 있다.
- 느린 트랜잭션
- 51% 공격의 위험성
```

```markdown
51% 공격이란 블록체인의 전체 노드 중 50%를 초과하는 해시 연산력을 확보한 뒤, 거래 정보를 조작함으로써 이익을 얻으려는 해킹 공격이다.
```

**사용 코인**: 비트코인, 라이트코인



## 지분증명(PoS)

지분 증명(Proof of Stake) 알고리즘은 지분을 많이 가지고 있는 노드에게 블록을 생성할 권한을 준다. 소유 지분 양에 비례하여 블록 생성 권한을 높은 확률로 부여 받는다.

채굴자에게는 이자와 같은 방식으로 코인이 지급되며, 일정 수 이상의 코인을 보관하고 있는 지갑을 블록체인 네트워크에 연결시켜놓기만 하면 보상을 받을 수 있다. 블록 생성자와 지분 생성자의 이해관계를 일치시킴으로써 블록을 나쁜 의도로 생성할 동기부여를 업애며, 잘못 생성할 경우 패널티를 부여한다.

```markdown
### 장점
- 해시 파워가 많이 필요하지 않으므로 경제적(빠른 트랜잭션)이며 친환경적이다.
- 블록 생산자의 탈중앙화로 안정성을 확보할 수 있다.
- 블록을 생성하기 위해 지분을 담보로 잡아야하기 때문에 dumping을 방지할 수 있다.
- 51% 공격에 내성
### 단점
- 보안성이 아직 검증되지 않았다.
- 지분이 많은 고래들이 권력을 독점할 가능성이 존재한다.
```

**사용 코인**: 퀀텀 네오, 스트라디스

### 위임지분증명(DPoS)

위임 지분 증명(Delegated Proof of Stake)은 PoS에서 변형된 것으로, 시스템의 지분을 가진 각 노드가 투표를 통해 트랜잭션의 유효성 검사를 다른 노드에 위임하여 증명하는 개념이다. 투표에서 선출된 노드는 상위 노드 혹은 witness(증인)이라고 지칭한다.

**장점**

- POS에 비해 많은 트랜잭션을 빠르게 처리 가능하다.
- POW에 비해 비용이 낮다.
- 하드포크의 위험이 낮다.
- 증인들이 투표에 참여할 인센티브가 분명하다.

**단점**

- 증인끼리 손쉽게 담합할 위험이 있다.
- 공개된 소수의 증인에 대한 DDos 공격 위험이 있다.
- 탈중앙성 부족

**사용 코인**: 스팀 이오스, 아크 라이즈



## BFT

비잔틴 장애 허용(Byzantine Fault Tolerance)는 장애가 있더라도 전체의 3분의 1을 넘지 않는다면, 시스템이 정상 작동하도록 허용하는 합의 알고리즘이다.

> - **CFT(Crash Fault Tolerance)**: 분산시스템에서 노드가 비정상적인 충돌에 의해 문제가 생기더라도, 나머지 시스템에서 서비스를 할 수 있게 하는 작동 방식
> - **BFT(Byzantine Fault Tolerance)**: 더 복잡하고 악의적인 행위자가 있을 수 있는 시스템을 처리

**작동 방식**

1. Client가 모든 노드에 요청(request)을 브로드캐스트한다.
2. 제일 처음, 리더(leader)가 순차적으로 명령을 다른 노드에 전달한다.
3. 각 노드는 브로드캐스트된 명령을 받게 되면, 리더를 포함한 모든 노드에 회신한다.
4. 각 노드는 전달된 명령을 일정 수 이상(2n)이 수신하면 리더를 포함한 모든 노드에 수신한 신호를 재전송한다.
5. 각 노드는 수신된 명령을 일정 수 이상(2n) 수신하면 명령을 실행하고 블록을 등록해 client에 replay된 메시지를 반환한다.

```markdown
#### 장점
- 다수결로 의사결정 후 블록을 만들었기 때문에 블록체인의 분기가 발생하지 않음
- 한 번 확정된 블록은 변경되지 않기 때문에 완결성 확보
- PoW와 같이 조건 만족 시까지 계산을 반복하지 않기 때문에 매우 빠르게 동작
#### 단점
- 언제나 참가자 전원과 소통하기 때문에 확장성이 낮음(PoW나 PoS는 수천 개의 노드를 만들 수 있는 반면, BFT는 수십 개의 노드가 한계)
```

### PBFT

프랙티컬 비잔틴 장애 허용(Practical Byzantine Fault Tolerance)은 비동기 네트워크에서 합의를 이룰 수 있도록 개발된 합의 알고리즘이다. (BFT는 동기식 네트워크에서만 합의 가능)

참가자 1명이 primary(리더)가 되어 모든 참가자에게 요청 송신 및 그 요청에 대한 결과를 집계한 뒤, 다수의 값을 사용해 블록을 확정하는 합의 알고리즘이다. PBFT는 두 번의 브로드캐스트 과정을 이용해 리더나 검증 노드가 임의의 메시지를 보내도 네트워크의 모든 노드는 같은 메시지를 가질 수 있게 한다. PBFT는 네오, 질리카, 하이퍼레저, R3, ITC, 텐더민트 등에서 사용한다.

**작동 방식**

1. Leader(Primary)가 Client의 요청을 수집하여 정렬하고 실행 결과와 함께 다른 노드들에 전파한다.
2. Leader의 메시지를 받은 노드들은 다른 노드들에게 받은 메시지를 다시 한 번 전파한다.
3. 모든 노드는 자신이 다른 노드에서 가장 많인 받은 같은 메시지(일정 수 이상)가 무엇인지 다른 노드들에게 전파한다.
4. 위 단계가 모두 끝나면, 모든 노드는 합의를 이룬(일정 수 이상 동의) 같은 데이터를 가지게 되고, 명령을 실행하고 블록을 등록한다.

```markdown
#### 장점
- 트랜잭션 완결성
- 빠른 거래 확정
- 비용 감소: PBFT는 PoW가 아닌 PoS를 기본으로 하여 에너지 사용량이 적고, 따라서 거래 비용이 적다.
#### 단점
- 참여자 사전 파악 필요
- 참가자 증가 시 성능 하락: Public 블록체인에는 적합한 방식하지 않음
```

**사용 코인**: 패브릭

#### Tendermint

Cosmos에서 사용하는 알고리즘으로, PBFT 알고리즘을 DPoS 개념과 섞어 공개/비공개 블록체인에 맞도록 개량한 합의 알고리즘이다. 차이점은 지분(Stake)을 기반으로 투표하게 된다는 것이다.

- Locking 메커니즘: 투표에 참여한 지분을 네트워크에 동결시키고 이를 해제하는 메커니즘을 통해 이중 투표 문제 방지
- Nothing of Stake 문제 해결: 악의적인 행위를 하면 지분을 빼앗는 방법으로 해당 노드를 처벌

전체 합의 프로세스는 PBFT와 거의 유사하다. Tendermint 프로세스에서의 Propose는 PBFT의 Pre-Prepare, Prevote는 Prepare, Precommit은 PBFT의 Commit으로 매칭시켜 이해하면 된다.

```markdown
#### 장점
- 블록을 노드들에게 전파(gossip)하는 방식을 단순화하여 확장성 제고
- 블록제안자를 수시로 교체할 수 있게 하여 안정성 제고
- 비잔티움 노드를 쉽게 발견하여 처벌할 수 있도록 함
```

### DBFT

DBFT(Delegated Byzantine Fault Tolerant)의 특징은 다음과 같다.

- 지분이 있으면 대표자 투표 권한을 가진다.
- 전체의 2/3 이상(다수결) 동의 시 블록 연결에 성공한다.

```markdown
#### 장점
- 빠른 처리 속도
- 포크가 일어나지 않고 완료성이 좋음
#### 단점
- 특정 노드에 권력 집중
- 노드들 간 단합 위험
```

### IBFT

IBFT(Istanbul BFT)

### RBFT

### Mir-BFT

### NCCU BFT

### Simple BFT

### MinBFT



## 기타

### 경과시간증명(PoET)

경과시간증명은 경쟁적 연산으로 낭비되는 에너지를 줄이면서 작업 증명과 유사 효과를 가진다. 하이퍼레저 Sawtooth Lake에서 제안하였으며, 인텔 SGX를 기반으로 블록을 생성하는 리더를 랜덤으로 선정한다.

**장점**

- 검증된 방법의 개선
- 에너지 낭비 적음

**단점**

- 특정 HW 종속

**사용 코인**: 쏘투스(Sawtooth)

### 권한증명(PoA)

트랜잭션 및 블록의 validator라고 승인된 계정에 의해 유효성이 검사된다. Validator는 권리를 얻으므로 그 지위를 유지하고자하고, 자신의 신원에 부정적 평판이 생기길 워하지 않도록 노력할 것이라는 가정을 바탕으로 한다.

**유형**: 프라이빗 허가형 컨소시엄

### PAXOS

트랜잭션 및 블록의 validator라고 승인된 계정에 의해 유효성이 검사된다. Validator는 권리를 얻으므로 그 지위를 유지하고자하고, 자신의 신원에 부정적 평판이 생기길 워하지 않도록 노력할 것이라는 가정을 바탕으로 한다.

**유형**: 프라이빗 허가형 컨소시엄

### RAFT

리더를 선정한 후 시스템의 모든 변화를 리더를 통해 결정하는 방식으로, 신뢰된 네트워크에서만 사용한다.

**단점**

- 리더의 조작 가능성
- BTF(Byzantine Fault)를 보장하지 않음

### Sieve

IBM에서 고안한 PBFT 확장 알고리즘으로, 실행 결과 전송 및 집계 결과 전송으로 흐름이 나뉜다.



***Copyright* © 2022 Song_Artish**